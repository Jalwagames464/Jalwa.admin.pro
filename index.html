<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JALWA PRO - GOD CONTROL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #06091b; --card: #10142d; --primary: #ffcc00;
            --green: #00c853; --red: #ff3d00; --blue: #2979ff;
            --text: #ffffff; --text-dim: #a4b0be; --violet: #9c27b0;
        }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); padding-bottom: 30px; }

        .top-nav { background: var(--card); padding: 15px; border-bottom: 2px solid #1e293b; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .killer-box { background: linear-gradient(90deg, #111, #10142d); border: 1px solid var(--red); margin: 15px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 20px rgba(255,0,0,0.2); }

        .tab-bar { display: flex; background: var(--card); margin: 10px 15px; border-radius: 12px; padding: 5px; gap: 5px; border: 1px solid #2d3748; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-dim); font-weight: bold; cursor: pointer; border-radius: 10px; font-size: 11px; transition: 0.3s; text-align: center;}
        .tab-btn.active { background: var(--primary); color: #000; }

        .container { padding: 0 15px; }
        .section { display: none; }
        .section.active { display: block; }

        .color-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .c-btn { padding: 20px 5px; border-radius: 12px; text-align: center; font-weight: 900; cursor: pointer; position: relative; border: 2px solid transparent; }
        .c-btn span { display: block; font-size: 12px; margin-top: 8px; background: rgba(0,0,0,0.4); border-radius: 5px; }
        
        .grid-nums { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .num-btn { aspect-ratio: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; position: relative; font-size: 18px; border: 2px solid #333; }
        .num-amt { position: absolute; top: -12px; font-size: 10px; color: var(--primary); background: #000; padding: 1px 4px; border-radius: 4px; border: 1px solid #444; }

        .player-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--blue); }
        .p-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
        .p-label { color: var(--text-dim); }
        .p-val { color: #fff; font-weight: bold; }
        
        .blink { animation: blinker 1s infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        
        .bet-active-blink { animation: red-flash 0.6s infinite alternate; }
        @keyframes red-flash { from { box-shadow: 0 0 0px #ff3d00; } to { box-shadow: 0 0 15px #ff3d00; background-color: #500; } }
        
        .fix-active { border: 3px solid #fff !important; transform: scale(1.05); box-shadow: 0 0 15px var(--primary); z-index: 5; }

        input[type="text"] { width: 100%; padding: 12px; background: #161d33; border: 1px solid #2d3748; color: white; border-radius: 8px; margin-bottom: 10px; }
        .btn-action { padding: 8px 12px; border-radius: 6px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body onload="initAdmin()">

<div class="top-nav">
    <div style="font-weight: 900; color: var(--primary); letter-spacing: 1px;">JALWA PRO ADMIN</div>
    <div id="liveClock" style="font-size: 12px; color: var(--green);">00:00:00</div>
</div>

<div class="killer-box">
    <div>
        <b style="color:var(--green)"><i class="fas fa-microchip"></i> KILLER ENGINE ACTIVE</b><br>
        <small id="killerPrediction" class="blink" style="color:var(--primary)">Analyzing Market Risk...</small>
    </div>
    <div style="text-align: right;">
        <small style="color:var(--text-dim); font-size: 10px;">PRO LOGIC</small><br>
        <i class="fas fa-check-circle" style="color:var(--green)"></i>
    </div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('wingo', this)">CONTROL</button>
    <button class="tab-btn" onclick="switchTab('users', this)">PLAYERS</button>
    <button class="tab-btn" onclick="switchTab('reqs', this)">PAYMENTS</button>
</div>

<div class="container">
    <div id="sec-wingo" class="section active">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:15px; background: #161d33; padding: 12px; border-radius: 12px; border: 1px solid #2d3748;">
            <div><small style="color:var(--text-dim)">PERIOD</small><br><b id="periodId" style="color:var(--blue)">-</b></div>
            <div style="text-align:right"><small style="color:var(--text-dim)">TIMER</small><br><b id="timer" style="font-size:24px; color:var(--red)">00s</b></div>
        </div>

        <div class="color-row">
            <div id="btnGreen" class="c-btn" style="background:var(--green)" onclick="manualFix('Green')">GREEN<span id="sumGreen">â‚¹0</span></div>
            <div id="btnViolet" class="c-btn" style="background:var(--violet)" onclick="manualFix('Violet')">VIOLET<span id="sumViolet">â‚¹0</span></div>
            <div id="btnRed" class="c-btn" style="background:var(--red)" onclick="manualFix('Red')">RED<span id="sumRed">â‚¹0</span></div>
        </div>
        <div class="grid-nums" id="numGrid"></div>

        <div style="background: #111827; padding: 15px; border-radius: 12px; margin-top: 15px; border-top: 3px solid var(--primary);">
            <div id="safeAdvice" class="blink" style="color:var(--green); font-weight: bold; font-size: 14px;">SCANNING BETS...</div>
            <div id="numberAdvice" style="margin-top:5px; font-size:12px; color:var(--text-dim);">System ready.</div>
        </div>
        <button onclick="resetAuto()" style="width:100%; margin-top:10px; padding:12px; background:#1e293b; color:white; border:0; border-radius:8px; font-size:12px; font-weight: bold;">RESET TO SMART AUTO</button>
    </div>

    <div id="sec-users" class="section">
        <input type="text" id="uSearch" placeholder="ðŸ” Search Phone or ID..." oninput="searchUser()">
        <div id="userList"></div>
    </div>

    <div id="sec-reqs" class="section">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button id="pBtnDep" class="btn-action" style="background:var(--green); flex:1" onclick="setPayTab('recharge')">DEPOSITS</button>
            <button id="pBtnWit" class="btn-action" style="background:var(--red); flex:1" onclick="setPayTab('withdrawal')">WITHDRAWS</button>
        </div>
        <div id="payList"><center style="color:var(--text-dim)">No pending requests</center></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://jalwav7-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let manualFixed = "none";
    let allPlayers = [];
    let activePayTab = 'recharge';

    function switchTab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
        el.classList.add('active');
        if(id === 'reqs') loadPayReqs();
    }

    function initAdmin() {
        let h = "";
        for(let i=0; i<=9; i++) {
            let col = (i==0||i==5)?'var(--violet)':(i%2==0? 'var(--red)':'var(--green)');
            h += `<div id="n${i}" class="num-btn" style="background:${col}" onclick="manualFix(${i})">${i}<div class="num-amt" id="vn${i}">â‚¹0</div></div>`;
        }
        document.getElementById('numGrid').innerHTML = h;

        setInterval(() => {
            const now = new Date();
            let timer = 30 - (now.getSeconds() % 30);
            document.getElementById('timer').innerText = timer + "s";
            document.getElementById('liveClock').innerText = now.toLocaleTimeString();
            
            let pStr = now.getFullYear().toString() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0');
            let round = Math.floor((now.getHours()*120) + (now.getMinutes()*2) + (now.getSeconds()/30));
            document.getElementById('periodId').innerText = pStr + (1000 + round);

            if(timer === 2) runKillerEngine(); 
        }, 1000);

        syncData();
        syncPlayers();
    }

    function syncData() {
        db.ref('gameControl/wingo/liveBets').on('value', snap => {
            const bets = snap.val() || {};
            let g = Number(bets.Green || 0), r = Number(bets.Red || 0), v = Number(bets.Violet || 0);
            document.getElementById('sumGreen').innerText = "â‚¹"+g;
            document.getElementById('sumRed').innerText = "â‚¹"+r;
            document.getElementById('sumViolet').innerText = "â‚¹"+v;
            let costs = [];
            for(let i=0; i<=9; i++) {
                let nAmt = Number(bets['num'+i] || 0);
                document.getElementById('vn'+i).innerText = "â‚¹"+nAmt;
                let cost = (nAmt * 9); 
                if(i === 0) cost += (v * 4.5) + (r * 1.5);
                else if(i === 5) cost += (v * 4.5) + (g * 1.5);
                else if(i % 2 === 0) cost += (r * 2);
                else cost += (g * 2);
                costs.push({ id: i, totalPayout: cost });
                document.getElementById('n'+i).classList.toggle('bet-active-blink', nAmt > 0);
            }
            let totalBets = g + r + v + costs.reduce((a, b) => a + b.totalPayout, 0);
            if(totalBets === 0) {
                document.getElementById('killerPrediction').innerText = "NO BETS: RANDOM MODE";
                document.getElementById('safeAdvice').innerText = "WAITING FOR PLAYER BETS...";
            } else {
                costs.sort((a,b) => a.totalPayout - b.totalPayout);
                let bestNum = costs[0].id;
                let bestCol = (bestNum==0||bestNum==5)?'VIOLET':(bestNum%2==0?'RED':'GREEN');
                document.getElementById('killerPrediction').innerText = `PREDICTION: ${bestCol} (${bestNum})`;
                document.getElementById('safeAdvice').innerHTML = `ðŸ”¥ KILLER CHOICE: <span style="color:var(--primary)">${bestCol}</span>`;
            }
        });
        db.ref('gameControl/manualResult').on('value', s => {
            manualFixed = s.val() || "none";
            document.querySelectorAll('.num-btn, .c-btn').forEach(el => el.classList.remove('fix-active'));
            if(manualFixed !== "none") {
                if(isNaN(manualFixed)) document.getElementById('btn'+manualFixed)?.classList.add('fix-active');
                else document.getElementById('n'+manualFixed)?.classList.add('fix-active');
            }
        });
    }

    async function runKillerEngine() {
        if(manualFixed !== "none") return;
        const snap = await db.ref('gameControl/wingo/liveBets').once('value');
        const b = snap.val() || {};
        let g = Number(b.Green || 0), r = Number(b.Red || 0), v = Number(b.Violet || 0);
        let costs = [];
        for(let i=0; i<=9; i++) {
            let nAmt = Number(b['num'+i] || 0);
            let payout = (nAmt * 9);
            if(i === 0) payout += (v * 4.5) + (r * 1.5);
            else if(i === 5) payout += (v * 4.5) + (g * 1.5);
            else if(i % 2 === 0) payout += (r * 2);
            else payout += (g * 2);
            costs.push({id: i, cost: payout});
        }
        if(g + r + v + costs.reduce((a,b)=>a+b.cost, 0) === 0) {
            let rand = [1,2,3,4,6,7,8,9];
            let pick = rand[Math.floor(Math.random() * rand.length)];
            db.ref('gameControl/manualResult').set(pick);
        } else {
            costs.sort((a,b) => a.cost - b.cost);
            db.ref('gameControl/manualResult').set(costs[0].id);
        }
    }

    function syncPlayers() {
        db.ref('users').on('value', snap => {
            allPlayers = [];
            snap.forEach(child => {
                let u = child.val();
                u.phoneKey = child.key; // Isme number (8081...) save hoga
                allPlayers.push(u);
            });
            renderUserList(allPlayers);
        });
    }

    function renderUserList(list) {
        let h = "";
        list.forEach(u => {
            h += `<div class="player-card">
                <div class="p-row"><span class="p-label">Name:</span> <span class="p-val" style="color:var(--primary)">${u.username || 'User'}</span></div>
                <div class="p-row"><span class="p-label">Phone:</span> <span class="p-val">${u.phone || u.phoneKey}</span></div>
                <div class="p-row"><span class="p-label">Pass:</span> <span class="p-val" style="color:var(--green)">${u.password}</span></div>
                <div class="p-row"><span class="p-label">UID:</span> <span class="p-val" style="font-size:10px;">${u.uid || u.phoneKey}</span></div>
                <div class="p-row" style="border-top:1px solid #2d3748; padding-top:5px; margin-top:5px;">
                    <span class="p-label">Balance:</span> <b style="color:var(--primary)">â‚¹${Number(u.balance).toFixed(2)}</b>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn-action" style="background:var(--blue); flex:1" onclick="editBal('${u.phoneKey}')">EDIT BALANCE</button>
                    <button class="btn-action" style="background:var(--red)" onclick="delUser('${u.phoneKey}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        });
        document.getElementById('userList').innerHTML = h || "<center>No players found</center>";
    }

    function searchUser() {
        let val = document.getElementById('uSearch').value.toLowerCase();
        let filtered = allPlayers.filter(p => (p.phoneKey && p.phoneKey.includes(val)) || (p.username && p.username.toLowerCase().includes(val)));
        renderUserList(filtered);
    }

    function manualFix(v) { db.ref('gameControl/manualResult').set(v); }
    function resetAuto() { db.ref('gameControl/manualResult').set('none'); }
    function editBal(id) { 
        let b = prompt("Enter new balance:"); 
        if(b !== null) db.ref('users/'+id).update({balance: Number(b)}); 
    }
    function delUser(id) { if(confirm("Delete user?")) db.ref('users/'+id).remove(); }

    // --- PAYMENTS FIXED LOGIC ---
    function setPayTab(t) {
        activePayTab = t;
        document.getElementById('pBtnDep').style.opacity = (t==='recharge') ? '1' : '0.5';
        document.getElementById('pBtnWit').style.opacity = (t==='withdrawal') ? '1' : '0.5';
        loadPayReqs();
    }

    function loadPayReqs() {
        const listDiv = document.getElementById('payList');
        db.ref('requests').on('value', snap => {
            let html = "";
            let foundData = false;
            const allReqs = snap.val();
            if(!allReqs) return listDiv.innerHTML = "<center>No requests</center>";

            Object.keys(allReqs).forEach(folder => {
                let isMatch = (activePayTab === 'recharge' && /recharge|dep/i.test(folder)) || 
                              (activePayTab === 'withdrawal' && /withdraw/i.test(folder));
                
                if(isMatch) {
                    let items = allReqs[folder];
                    Object.keys(items).forEach(id => {
                        let d = items[id];
                        if(d.status === 'pending' || !d.status) {
                            foundData = true;
                            
                            // Aggressive User Matching
                            let reqUid = d.uid || d.userId;
                            let player = allPlayers.find(p => p.uid === reqUid || p.phoneKey === reqUid) || {};
                            let pName = player.phoneKey || player.username || reqUid || "Unknown";

                            html += `<div class="player-card" style="border-left:5px solid ${activePayTab==='recharge'?'var(--green)':'var(--red)'}">
                                <div class="p-row"><b>â‚¹${d.amount}</b> <small style="opacity:0.5">${folder}</small></div>
                                <div style="margin:10px 0; color:#fff;">
                                    <div style="font-size:16px; font-weight:bold; color:var(--primary)"><i class="fas fa-user-circle"></i> ${pName}</div>
                                    <div style="font-size:9px; opacity:0.4;">UID: ${reqUid}</div>
                                </div>
                                ${d.utr ? `<div style="background:#000; padding:8px; border-radius:5px; margin-bottom:10px; color:var(--blue); font-size:12px; border:1px solid #222; font-weight:bold;">UTR: ${d.utr}</div>` : ''}
                                <div style="display:flex; gap:10px;">
                                    <button class="btn-action" style="background:var(--green); flex:1; padding:12px;" onclick="handlePay('${folder}/${id}','${player.phoneKey || reqUid}',${d.amount},'approved')">APPROVE</button>
                                    <button class="btn-action" style="background:var(--red); flex:1; padding:12px;" onclick="handlePay('${folder}/${id}','${player.phoneKey || reqUid}',${d.amount},'rejected')">REJECT</button>
                                </div>
                            </div>`;
                        }
                    });
                }
            });
            listDiv.innerHTML = foundData ? html : "<center>No pending "+activePayTab+"</center>";
        });
    }

    async function handlePay(path, userKey, amt, status) {
        await db.ref('requests/' + path).update({ status: status });
        if(status === 'approved' && activePayTab === 'recharge') {
            db.ref('users/' + userKey + '/balance').transaction(c => (Number(c) || 0) + Number(amt));
        } else if(status === 'rejected' && activePayTab === 'withdrawal') {
            db.ref('users/' + userKey + '/balance').transaction(c => (Number(c) || 0) + Number(amt));
        }
    }
</script>
</body>
</html>
